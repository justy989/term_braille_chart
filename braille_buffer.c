#include "braille_buffer.h"

#include <stdlib.h>
#include <string.h>
#include <math.h>

bool braille_buffer_init(BrailleBuffer_t* braille_buffer, int32_t terminal_width, int32_t terminal_height){
     if(braille_buffer->cells) braille_buffer_free(braille_buffer);
     int32_t total_cells = terminal_width * terminal_height;
     braille_buffer->cells = calloc(total_cells, sizeof(*braille_buffer->cells));
     if(!braille_buffer->cells) return false;
     braille_buffer->width = terminal_width;
     braille_buffer->height = terminal_height;
     return true;
}

void braille_buffer_free(BrailleBuffer_t* braille_buffer){
     free(braille_buffer->cells);
     memset(braille_buffer, 0, sizeof(*braille_buffer));
}

uint8_t* braille_buffer_get_cell(BrailleBuffer_t* braille_buffer, int32_t x, int32_t y){
     // if(x < 0 || y < 0 || x >= braille_buffer->width * BRAILLE_COLUMNS_PER_CELL || y >= braille_buffer->height * BRAILLE_ROWS_PER_CELL) return NULL;
     int32_t index = y * braille_buffer->width + x;
     return braille_buffer->cells + index;
}

bool braille_buffer_set_pixel(BrailleBuffer_t* braille_buffer, int32_t x, int32_t y, bool on){
     // if(x < 0 || y < 0) return false;

     // int32_t max_x = braille_buffer->width * BRAILLE_COLUMNS_PER_CELL;
     // int32_t max_y = braille_buffer->height * BRAILLE_ROWS_PER_CELL;
     // if(x >= max_x || y >= max_y) return false;

     int32_t cell_x = x / BRAILLE_COLUMNS_PER_CELL;
     int32_t cell_y = y / BRAILLE_ROWS_PER_CELL;
     int32_t pixel_x = x % BRAILLE_COLUMNS_PER_CELL;
     int32_t pixel_y = y % BRAILLE_ROWS_PER_CELL;

     static const uint8_t map[BRAILLE_ROWS_PER_CELL][BRAILLE_COLUMNS_PER_CELL] = {
          {0x1, 0x8},
          {0x2, 0x10},
          {0x4, 0x20},
          {0x40, 0x80}
     };

     uint8_t* cell = braille_buffer_get_cell(braille_buffer, cell_x, cell_y);
     if(!cell) return false;

     if(on){
          *cell |= map[pixel_y][pixel_x];
     }else{
          *cell &= ~map[pixel_y][pixel_x];
     }

     return true;
}

void braille_buffer_clear(BrailleBuffer_t* braille_buffer){
     int32_t count = braille_buffer->width * braille_buffer->height;
     memset(braille_buffer->cells, 0, count);
}

void braille_buffer_draw(BrailleBuffer_t* braille_buffer, WINDOW* window){
     static const char unicode_lookup[256][4] = {
          {0xe2, 0xa0, 0x80, 0x0},
          {0xe2, 0xa0, 0x81, 0x0},
          {0xe2, 0xa0, 0x82, 0x0},
          {0xe2, 0xa0, 0x83, 0x0},
          {0xe2, 0xa0, 0x84, 0x0},
          {0xe2, 0xa0, 0x85, 0x0},
          {0xe2, 0xa0, 0x86, 0x0},
          {0xe2, 0xa0, 0x87, 0x0},
          {0xe2, 0xa0, 0x88, 0x0},
          {0xe2, 0xa0, 0x89, 0x0},
          {0xe2, 0xa0, 0x8a, 0x0},
          {0xe2, 0xa0, 0x8b, 0x0},
          {0xe2, 0xa0, 0x8c, 0x0},
          {0xe2, 0xa0, 0x8d, 0x0},
          {0xe2, 0xa0, 0x8e, 0x0},
          {0xe2, 0xa0, 0x8f, 0x0},
          {0xe2, 0xa0, 0x90, 0x0},
          {0xe2, 0xa0, 0x91, 0x0},
          {0xe2, 0xa0, 0x92, 0x0},
          {0xe2, 0xa0, 0x93, 0x0},
          {0xe2, 0xa0, 0x94, 0x0},
          {0xe2, 0xa0, 0x95, 0x0},
          {0xe2, 0xa0, 0x96, 0x0},
          {0xe2, 0xa0, 0x97, 0x0},
          {0xe2, 0xa0, 0x98, 0x0},
          {0xe2, 0xa0, 0x99, 0x0},
          {0xe2, 0xa0, 0x9a, 0x0},
          {0xe2, 0xa0, 0x9b, 0x0},
          {0xe2, 0xa0, 0x9c, 0x0},
          {0xe2, 0xa0, 0x9d, 0x0},
          {0xe2, 0xa0, 0x9e, 0x0},
          {0xe2, 0xa0, 0x9f, 0x0},
          {0xe2, 0xa0, 0xa0, 0x0},
          {0xe2, 0xa0, 0xa1, 0x0},
          {0xe2, 0xa0, 0xa2, 0x0},
          {0xe2, 0xa0, 0xa3, 0x0},
          {0xe2, 0xa0, 0xa4, 0x0},
          {0xe2, 0xa0, 0xa5, 0x0},
          {0xe2, 0xa0, 0xa6, 0x0},
          {0xe2, 0xa0, 0xa7, 0x0},
          {0xe2, 0xa0, 0xa8, 0x0},
          {0xe2, 0xa0, 0xa9, 0x0},
          {0xe2, 0xa0, 0xaa, 0x0},
          {0xe2, 0xa0, 0xab, 0x0},
          {0xe2, 0xa0, 0xac, 0x0},
          {0xe2, 0xa0, 0xad, 0x0},
          {0xe2, 0xa0, 0xae, 0x0},
          {0xe2, 0xa0, 0xaf, 0x0},
          {0xe2, 0xa0, 0xb0, 0x0},
          {0xe2, 0xa0, 0xb1, 0x0},
          {0xe2, 0xa0, 0xb2, 0x0},
          {0xe2, 0xa0, 0xb3, 0x0},
          {0xe2, 0xa0, 0xb4, 0x0},
          {0xe2, 0xa0, 0xb5, 0x0},
          {0xe2, 0xa0, 0xb6, 0x0},
          {0xe2, 0xa0, 0xb7, 0x0},
          {0xe2, 0xa0, 0xb8, 0x0},
          {0xe2, 0xa0, 0xb9, 0x0},
          {0xe2, 0xa0, 0xba, 0x0},
          {0xe2, 0xa0, 0xbb, 0x0},
          {0xe2, 0xa0, 0xbc, 0x0},
          {0xe2, 0xa0, 0xbd, 0x0},
          {0xe2, 0xa0, 0xbe, 0x0},
          {0xe2, 0xa0, 0xbf, 0x0},
          {0xe2, 0xa1, 0x80, 0x0},
          {0xe2, 0xa1, 0x81, 0x0},
          {0xe2, 0xa1, 0x82, 0x0},
          {0xe2, 0xa1, 0x83, 0x0},
          {0xe2, 0xa1, 0x84, 0x0},
          {0xe2, 0xa1, 0x85, 0x0},
          {0xe2, 0xa1, 0x86, 0x0},
          {0xe2, 0xa1, 0x87, 0x0},
          {0xe2, 0xa1, 0x88, 0x0},
          {0xe2, 0xa1, 0x89, 0x0},
          {0xe2, 0xa1, 0x8a, 0x0},
          {0xe2, 0xa1, 0x8b, 0x0},
          {0xe2, 0xa1, 0x8c, 0x0},
          {0xe2, 0xa1, 0x8d, 0x0},
          {0xe2, 0xa1, 0x8e, 0x0},
          {0xe2, 0xa1, 0x8f, 0x0},
          {0xe2, 0xa1, 0x90, 0x0},
          {0xe2, 0xa1, 0x91, 0x0},
          {0xe2, 0xa1, 0x92, 0x0},
          {0xe2, 0xa1, 0x93, 0x0},
          {0xe2, 0xa1, 0x94, 0x0},
          {0xe2, 0xa1, 0x95, 0x0},
          {0xe2, 0xa1, 0x96, 0x0},
          {0xe2, 0xa1, 0x97, 0x0},
          {0xe2, 0xa1, 0x98, 0x0},
          {0xe2, 0xa1, 0x99, 0x0},
          {0xe2, 0xa1, 0x9a, 0x0},
          {0xe2, 0xa1, 0x9b, 0x0},
          {0xe2, 0xa1, 0x9c, 0x0},
          {0xe2, 0xa1, 0x9d, 0x0},
          {0xe2, 0xa1, 0x9e, 0x0},
          {0xe2, 0xa1, 0x9f, 0x0},
          {0xe2, 0xa1, 0xa0, 0x0},
          {0xe2, 0xa1, 0xa1, 0x0},
          {0xe2, 0xa1, 0xa2, 0x0},
          {0xe2, 0xa1, 0xa3, 0x0},
          {0xe2, 0xa1, 0xa4, 0x0},
          {0xe2, 0xa1, 0xa5, 0x0},
          {0xe2, 0xa1, 0xa6, 0x0},
          {0xe2, 0xa1, 0xa7, 0x0},
          {0xe2, 0xa1, 0xa8, 0x0},
          {0xe2, 0xa1, 0xa9, 0x0},
          {0xe2, 0xa1, 0xaa, 0x0},
          {0xe2, 0xa1, 0xab, 0x0},
          {0xe2, 0xa1, 0xac, 0x0},
          {0xe2, 0xa1, 0xad, 0x0},
          {0xe2, 0xa1, 0xae, 0x0},
          {0xe2, 0xa1, 0xaf, 0x0},
          {0xe2, 0xa1, 0xb0, 0x0},
          {0xe2, 0xa1, 0xb1, 0x0},
          {0xe2, 0xa1, 0xb2, 0x0},
          {0xe2, 0xa1, 0xb3, 0x0},
          {0xe2, 0xa1, 0xb4, 0x0},
          {0xe2, 0xa1, 0xb5, 0x0},
          {0xe2, 0xa1, 0xb6, 0x0},
          {0xe2, 0xa1, 0xb7, 0x0},
          {0xe2, 0xa1, 0xb8, 0x0},
          {0xe2, 0xa1, 0xb9, 0x0},
          {0xe2, 0xa1, 0xba, 0x0},
          {0xe2, 0xa1, 0xbb, 0x0},
          {0xe2, 0xa1, 0xbc, 0x0},
          {0xe2, 0xa1, 0xbd, 0x0},
          {0xe2, 0xa1, 0xbe, 0x0},
          {0xe2, 0xa1, 0xbf, 0x0},
          {0xe2, 0xa2, 0x80, 0x0},
          {0xe2, 0xa2, 0x81, 0x0},
          {0xe2, 0xa2, 0x82, 0x0},
          {0xe2, 0xa2, 0x83, 0x0},
          {0xe2, 0xa2, 0x84, 0x0},
          {0xe2, 0xa2, 0x85, 0x0},
          {0xe2, 0xa2, 0x86, 0x0},
          {0xe2, 0xa2, 0x87, 0x0},
          {0xe2, 0xa2, 0x88, 0x0},
          {0xe2, 0xa2, 0x89, 0x0},
          {0xe2, 0xa2, 0x8a, 0x0},
          {0xe2, 0xa2, 0x8b, 0x0},
          {0xe2, 0xa2, 0x8c, 0x0},
          {0xe2, 0xa2, 0x8d, 0x0},
          {0xe2, 0xa2, 0x8e, 0x0},
          {0xe2, 0xa2, 0x8f, 0x0},
          {0xe2, 0xa2, 0x90, 0x0},
          {0xe2, 0xa2, 0x91, 0x0},
          {0xe2, 0xa2, 0x92, 0x0},
          {0xe2, 0xa2, 0x93, 0x0},
          {0xe2, 0xa2, 0x94, 0x0},
          {0xe2, 0xa2, 0x95, 0x0},
          {0xe2, 0xa2, 0x96, 0x0},
          {0xe2, 0xa2, 0x97, 0x0},
          {0xe2, 0xa2, 0x98, 0x0},
          {0xe2, 0xa2, 0x99, 0x0},
          {0xe2, 0xa2, 0x9a, 0x0},
          {0xe2, 0xa2, 0x9b, 0x0},
          {0xe2, 0xa2, 0x9c, 0x0},
          {0xe2, 0xa2, 0x9d, 0x0},
          {0xe2, 0xa2, 0x9e, 0x0},
          {0xe2, 0xa2, 0x9f, 0x0},
          {0xe2, 0xa2, 0xa0, 0x0},
          {0xe2, 0xa2, 0xa1, 0x0},
          {0xe2, 0xa2, 0xa2, 0x0},
          {0xe2, 0xa2, 0xa3, 0x0},
          {0xe2, 0xa2, 0xa4, 0x0},
          {0xe2, 0xa2, 0xa5, 0x0},
          {0xe2, 0xa2, 0xa6, 0x0},
          {0xe2, 0xa2, 0xa7, 0x0},
          {0xe2, 0xa2, 0xa8, 0x0},
          {0xe2, 0xa2, 0xa9, 0x0},
          {0xe2, 0xa2, 0xaa, 0x0},
          {0xe2, 0xa2, 0xab, 0x0},
          {0xe2, 0xa2, 0xac, 0x0},
          {0xe2, 0xa2, 0xad, 0x0},
          {0xe2, 0xa2, 0xae, 0x0},
          {0xe2, 0xa2, 0xaf, 0x0},
          {0xe2, 0xa2, 0xb0, 0x0},
          {0xe2, 0xa2, 0xb1, 0x0},
          {0xe2, 0xa2, 0xb2, 0x0},
          {0xe2, 0xa2, 0xb3, 0x0},
          {0xe2, 0xa2, 0xb4, 0x0},
          {0xe2, 0xa2, 0xb5, 0x0},
          {0xe2, 0xa2, 0xb6, 0x0},
          {0xe2, 0xa2, 0xb7, 0x0},
          {0xe2, 0xa2, 0xb8, 0x0},
          {0xe2, 0xa2, 0xb9, 0x0},
          {0xe2, 0xa2, 0xba, 0x0},
          {0xe2, 0xa2, 0xbb, 0x0},
          {0xe2, 0xa2, 0xbc, 0x0},
          {0xe2, 0xa2, 0xbd, 0x0},
          {0xe2, 0xa2, 0xbe, 0x0},
          {0xe2, 0xa2, 0xbf, 0x0},
          {0xe2, 0xa3, 0x80, 0x0},
          {0xe2, 0xa3, 0x81, 0x0},
          {0xe2, 0xa3, 0x82, 0x0},
          {0xe2, 0xa3, 0x83, 0x0},
          {0xe2, 0xa3, 0x84, 0x0},
          {0xe2, 0xa3, 0x85, 0x0},
          {0xe2, 0xa3, 0x86, 0x0},
          {0xe2, 0xa3, 0x87, 0x0},
          {0xe2, 0xa3, 0x88, 0x0},
          {0xe2, 0xa3, 0x89, 0x0},
          {0xe2, 0xa3, 0x8a, 0x0},
          {0xe2, 0xa3, 0x8b, 0x0},
          {0xe2, 0xa3, 0x8c, 0x0},
          {0xe2, 0xa3, 0x8d, 0x0},
          {0xe2, 0xa3, 0x8e, 0x0},
          {0xe2, 0xa3, 0x8f, 0x0},
          {0xe2, 0xa3, 0x90, 0x0},
          {0xe2, 0xa3, 0x91, 0x0},
          {0xe2, 0xa3, 0x92, 0x0},
          {0xe2, 0xa3, 0x93, 0x0},
          {0xe2, 0xa3, 0x94, 0x0},
          {0xe2, 0xa3, 0x95, 0x0},
          {0xe2, 0xa3, 0x96, 0x0},
          {0xe2, 0xa3, 0x97, 0x0},
          {0xe2, 0xa3, 0x98, 0x0},
          {0xe2, 0xa3, 0x99, 0x0},
          {0xe2, 0xa3, 0x9a, 0x0},
          {0xe2, 0xa3, 0x9b, 0x0},
          {0xe2, 0xa3, 0x9c, 0x0},
          {0xe2, 0xa3, 0x9d, 0x0},
          {0xe2, 0xa3, 0x9e, 0x0},
          {0xe2, 0xa3, 0x9f, 0x0},
          {0xe2, 0xa3, 0xa0, 0x0},
          {0xe2, 0xa3, 0xa1, 0x0},
          {0xe2, 0xa3, 0xa2, 0x0},
          {0xe2, 0xa3, 0xa3, 0x0},
          {0xe2, 0xa3, 0xa4, 0x0},
          {0xe2, 0xa3, 0xa5, 0x0},
          {0xe2, 0xa3, 0xa6, 0x0},
          {0xe2, 0xa3, 0xa7, 0x0},
          {0xe2, 0xa3, 0xa8, 0x0},
          {0xe2, 0xa3, 0xa9, 0x0},
          {0xe2, 0xa3, 0xaa, 0x0},
          {0xe2, 0xa3, 0xab, 0x0},
          {0xe2, 0xa3, 0xac, 0x0},
          {0xe2, 0xa3, 0xad, 0x0},
          {0xe2, 0xa3, 0xae, 0x0},
          {0xe2, 0xa3, 0xaf, 0x0},
          {0xe2, 0xa3, 0xb0, 0x0},
          {0xe2, 0xa3, 0xb1, 0x0},
          {0xe2, 0xa3, 0xb2, 0x0},
          {0xe2, 0xa3, 0xb3, 0x0},
          {0xe2, 0xa3, 0xb4, 0x0},
          {0xe2, 0xa3, 0xb5, 0x0},
          {0xe2, 0xa3, 0xb6, 0x0},
          {0xe2, 0xa3, 0xb7, 0x0},
          {0xe2, 0xa3, 0xb8, 0x0},
          {0xe2, 0xa3, 0xb9, 0x0},
          {0xe2, 0xa3, 0xba, 0x0},
          {0xe2, 0xa3, 0xbb, 0x0},
          {0xe2, 0xa3, 0xbc, 0x0},
          {0xe2, 0xa3, 0xbd, 0x0},
          {0xe2, 0xa3, 0xbe, 0x0},
          {0xe2, 0xa3, 0xbf, 0x0},
     };

     int32_t count = braille_buffer->width * braille_buffer->height;
     uint8_t* cell = braille_buffer->cells;
     for(int32_t i = 0; i < count; i++){
          if(*cell){
               int32_t x = i % braille_buffer->width;
               int32_t y = i / braille_buffer->width;
               mvwaddstr(window, braille_buffer->y_offset + y, braille_buffer->x_offset + x, unicode_lookup[*cell]);
          }
          cell++;
     }
}

int32_t braille_buffer_pixel_width(BrailleBuffer_t* braille_buffer){
     return braille_buffer->width * BRAILLE_COLUMNS_PER_CELL;
}

int32_t braille_buffer_pixel_height(BrailleBuffer_t* braille_buffer){
     return braille_buffer->height * BRAILLE_ROWS_PER_CELL;
}

// NOTE: bresenham line algo
void braille_buffer_line(BrailleBuffer_t* braille_buffer, int32_t x_0, int32_t y_0, int32_t x_1, int32_t y_1){
     int32_t dy = (y_0 < y_1) ? 1 : -1;

     if(x_0 == x_1){
          for(int32_t y = y_0; y <= y_1; y += dy){
               braille_buffer_set_pixel(braille_buffer, x_0, y, true);
          }
          return;
     }

     double delta_x = x_1 - x_0;
     double delta_y = y_1 - y_0;
     double delta_error = fabs(delta_y / delta_x);
     double error = 0.0f;
     int32_t y = y_0;
     int32_t dx = (x_0 < x_1) ? 1 : -1;
     for(int32_t x = x_0; x != x_1; x += dx){
          braille_buffer_set_pixel(braille_buffer, x, y, true);
          error += delta_error;
          while(error >= 0.5f){
               y += dy;
               error -= 1.0f;
          }
     }
}
